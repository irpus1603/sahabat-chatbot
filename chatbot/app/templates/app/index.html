<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sahabat - AI Assistant{% endblock %}</title>
    
    <!-- Bootstrap 5.3 CSS from getbootstrap.com -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Highlight.js for code syntax highlighting (server-side rendering) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- ChatGPT Dark Theme CSS -->
    <style>
        /* ChatGPT Color Palette */
        :root {
            --chatgpt-bg: #212121;
            --chatgpt-sidebar: #171717;
            --chatgpt-sidebar-hover: #2f2f2f;
            --chatgpt-user-msg: #2f2f2f;
            --chatgpt-assistant-msg: #212121;
            --chatgpt-input-bg: #40414f;
            --chatgpt-border: #40414f;
            --chatgpt-text: #ececf1;
            --chatgpt-text-muted: #8e8ea0;
            --chatgpt-text-secondary: #c5c5d2;
            --chatgpt-green: #10a37f;
            --chatgpt-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Base styles */
        body {
            background-color: var(--chatgpt-bg) !important;
            color: var(--chatgpt-text) !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        /* Animations */
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out;
            background-color: var(--chatgpt-text-muted) !important;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        /* Sidebar */
        .sidebar {
            background-color: var(--chatgpt-sidebar) !important;
            border-right: 1px solid var(--chatgpt-border) !important;
        }
        
        .sidebar.collapsed {
            width: 60px !important;
        }
        
        .sidebar.collapsed .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }
        
        .sidebar.collapsed .sidebar-icons {
            display: block !important;
        }
        
        .sidebar-icons {
            display: none !important;
        }
        
        .sidebar.collapsed .sidebar-toggle svg {
            transform: rotate(180deg);
        }
        
        .sidebar-toggle {
            right: -12px;
            z-index: 1000;
            background-color: var(--chatgpt-sidebar) !important;
            border-color: var(--chatgpt-border) !important;
            color: var(--chatgpt-text) !important;
        }
        
        .sidebar-toggle:hover {
            background-color: var(--chatgpt-sidebar-hover) !important;
        }
        
        /* Sidebar content */
        .sidebar h5 {
            color: var(--chatgpt-text) !important;
        }
        
        .sidebar .btn-outline-primary {
            border-color: var(--chatgpt-border) !important;
            color: var(--chatgpt-text) !important;
            background-color: transparent !important;
        }
        
        .sidebar .btn-outline-primary:hover {
            background-color: var(--chatgpt-sidebar-hover) !important;
            border-color: var(--chatgpt-border) !important;
            color: var(--chatgpt-text) !important;
        }
        
        .sidebar .btn-outline-secondary {
            border-color: var(--chatgpt-border) !important;
            color: var(--chatgpt-text-muted) !important;
            background-color: transparent !important;
        }
        
        .sidebar .btn-outline-secondary:hover {
            background-color: var(--chatgpt-sidebar-hover) !important;
            border-color: var(--chatgpt-border) !important;
            color: var(--chatgpt-text) !important;
        }
        
        /* Chat header styles */
        .chat-header {
            background-color: var(--chatgpt-bg) !important;
            border-color: var(--chatgpt-border) !important;
        }
        
        .chat-header h6 {
            color: var(--chatgpt-text) !important;
        }
        
        .btn-outline-danger {
            border-color: #dc3545 !important;
            color: #dc3545 !important;
            background-color: transparent !important;
        }
        
        .btn-outline-danger:hover {
            background-color: rgba(220, 53, 69, 0.1) !important;
            border-color: #dc3545 !important;
            color: #ff6b6b !important;
        }
        
        /* Chat history */
        .chat-history-item {
            color: var(--chatgpt-text-muted) !important;
            background-color: transparent !important;
            border: none !important;
        }
        
        .chat-history-item:hover {
            background-color: var(--chatgpt-sidebar-hover) !important;
            color: var(--chatgpt-text) !important;
        }
        
        .delete-chat-btn {
            opacity: 0.5;
            transition: opacity 0.2s ease;
            color: var(--chatgpt-text-muted) !important;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .chat-history-item:hover .delete-chat-btn {
            opacity: 1 !important;
        }
        
        .delete-chat-btn:hover {
            background-color: rgba(220, 53, 69, 0.2) !important;
            color: #ff6b6b !important;
            opacity: 1 !important;
        }
        
        /* Fix for mobile - always show delete button on touch devices */
        @media (hover: none) {
            .delete-chat-btn {
                opacity: 0.7;
            }
        }
        
        /* Main content */
        .main-content {
            background-color: var(--chatgpt-bg) !important;
        }
        
        /* Messages */
        .message-user {
            background-color: var(--chatgpt-user-msg);
        }
        
        .message-assistant {
            background-color: var(--chatgpt-assistant-msg);
        }
        
        /* Input area */
        .input-area {
            background: linear-gradient(180deg, rgba(33, 33, 33, 0) 0%, var(--chatgpt-bg) 30%) !important;
        }
        
        .chat-input {
            background-color: var(--chatgpt-input-bg) !important;
            border: 1px solid var(--chatgpt-border) !important;
            color: var(--chatgpt-text) !important;
        }
        
        .chat-input:focus {
            border-color: var(--chatgpt-green) !important;
            box-shadow: 0 0 0 0.2rem rgba(16, 163, 127, 0.25) !important;
            background-color: var(--chatgpt-input-bg) !important;
            color: var(--chatgpt-text) !important;
        }
        
        .chat-input::placeholder {
            color: var(--chatgpt-text-muted) !important;
        }
        
        .send-btn {
            background-color: var(--chatgpt-green) !important;
            border: none !important;
        }
        
        .send-btn:hover:not(:disabled) {
            background-color: #0d8f68 !important;
        }
        
        /* Welcome cards */
        .card.bg-secondary {
            background-color: var(--chatgpt-sidebar-hover) !important;
            border: 1px solid var(--chatgpt-border) !important;
        }
        
        .card-title {
            color: var(--chatgpt-text) !important;
        }
        
        /* User dropdown */
        .dropdown-menu {
            background-color: var(--chatgpt-sidebar) !important;
            border-color: var(--chatgpt-border) !important;
        }
        
        .dropdown-item {
            color: var(--chatgpt-text) !important;
        }
        
        .dropdown-item:hover {
            background-color: var(--chatgpt-sidebar-hover) !important;
            color: var(--chatgpt-text) !important;
        }
        
        /* Markdown styles for dark theme */
        .ai-message-content {
            color: var(--chatgpt-text) !important;
        }
        
        .ai-message-content h1,
        .ai-message-content h2,
        .ai-message-content h3,
        .ai-message-content h4,
        .ai-message-content h5,
        .ai-message-content h6 {
            color: var(--chatgpt-text);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            line-height: 1.25;
        }
        
        .ai-message-content h1 { font-size: 1.5rem; }
        .ai-message-content h2 { font-size: 1.25rem; }
        .ai-message-content h3 { font-size: 1.125rem; }
        .ai-message-content h4 { font-size: 1rem; }
        .ai-message-content h5 { font-size: 0.875rem; }
        .ai-message-content h6 { font-size: 0.75rem; }
        
        .ai-message-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: var(--chatgpt-text);
        }
        
        .ai-message-content ul,
        .ai-message-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        
        .ai-message-content li {
            margin-bottom: 0.25rem;
            color: var(--chatgpt-text);
        }
        
        .ai-message-content blockquote {
            border-left: 4px solid var(--chatgpt-border);
            margin: 1rem 0;
            padding: 0.5rem 0 0.5rem 1rem;
            background-color: var(--chatgpt-user-msg);
            font-style: italic;
            color: var(--chatgpt-text-secondary);
        }
        
        .ai-message-content code {
            background-color: var(--chatgpt-user-msg);
            color: #ff6b6b;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        .ai-message-content pre {
            background-color: #0d1117;
            border: 1px solid var(--chatgpt-border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
            font-size: 0.875rem;
        }
        
        .ai-message-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
        }
        
        .ai-message-content table {
            width: 100%;
            margin-bottom: 1rem;
            border-collapse: collapse;
            color: var(--chatgpt-text);
        }
        
        .ai-message-content th,
        .ai-message-content td {
            padding: 0.5rem;
            border: 1px solid var(--chatgpt-border);
            text-align: left;
        }
        
        .ai-message-content th {
            background-color: var(--chatgpt-user-msg);
            font-weight: 600;
            color: var(--chatgpt-text);
        }
        
        .ai-message-content strong {
            font-weight: 600;
            color: var(--chatgpt-text);
        }
        
        .ai-message-content em {
            font-style: italic;
            color: var(--chatgpt-text-secondary);
        }
        
        .ai-message-content a {
            color: #4c9eff;
            text-decoration: underline;
        }
        
        .ai-message-content a:hover {
            color: #66b3ff;
        }
        
        .ai-message-content hr {
            margin: 1.5rem 0;
            border: 0;
            border-top: 1px solid var(--chatgpt-border);
        }
        
        /* Message bubbles - ChatGPT style */
        .user-bubble {
            background-color: var(--chatgpt-user-msg) !important;
            color: var(--chatgpt-text) !important;
            border: 1px solid var(--chatgpt-border) !important;
        }
        
        /* Text colors */
        .text-muted {
            color: var(--chatgpt-text-muted) !important;
        }
        
        /* Border colors */
        .border-bottom, .border-top {
            border-color: var(--chatgpt-border) !important;
        }

        /* Sidebar collapse CSS-only solution */
        #sidebar-collapse:checked ~ .sidebar {
            width: 60px !important;
        }
        
        #sidebar-collapse:checked ~ .sidebar .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }
        
        #sidebar-collapse:checked ~ .sidebar .sidebar-icons {
            display: block !important;
        }
        
        #sidebar-collapse:checked ~ .sidebar .sidebar-toggle svg {
            transform: rotate(180deg);
        }
        
        #sidebar-collapse:checked ~ .input-area {
            left: 60px !important;
        }
        
        /* Default collapsed state if set by server */
        {% if request.session.sidebar_collapsed %}
        .sidebar {
            width: 60px !important;
        }
        
        .sidebar .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }
        
        .sidebar .sidebar-icons {
            display: block !important;
        }
        
        .sidebar .sidebar-toggle svg {
            transform: rotate(180deg);
        }
        
        .input-area {
            left: 60px !important;
        }
        {% endif %}

        /* Mobile sidebar CSS-only solution */
        @media (max-width: 767px) {
            #mobile-sidebar-toggle:checked ~ .mobile-overlay {
                display: block !important;
            }
            
            #mobile-sidebar-toggle:checked ~ .sidebar {
                transform: translateX(0) !important;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
        }
    </style>
</head>
<body class="vh-100 overflow-hidden bg-light">
    <div class="vh-100 d-flex">
        <!-- Mobile Toggle Checkbox -->
        <input type="checkbox" id="mobile-sidebar-toggle" style="display: none;">
        
        <!-- Mobile Toggle Button -->
        <label for="mobile-sidebar-toggle" class="btn btn-light border position-fixed top-0 start-0 m-3 d-md-none" style="z-index: 1001; cursor: pointer;">
            â˜°
        </label>

        <!-- Mobile Overlay -->
        <label for="mobile-sidebar-toggle" class="mobile-overlay position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50" style="display: none; z-index: 999; cursor: pointer;"></label>

        <!-- Sidebar Collapse Checkbox -->
        <input type="checkbox" id="sidebar-collapse" style="display: none;" 
               hx-post="{% url 'toggle_sidebar_state' %}" 
               hx-trigger="change"
               hx-swap="none"
               {% if request.session.sidebar_collapsed %}checked{% endif %}>
        
        <!-- Sidebar -->
        <div class="sidebar d-flex flex-column position-relative overflow-hidden flex-shrink-0" id="sidebar" style="width: 280px; transition: width 0.3s ease;">
            <!-- Sidebar Toggle Button -->
            <label for="sidebar-collapse" class="sidebar-toggle position-absolute top-50 translate-middle-y btn btn-light btn-sm border rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; cursor: pointer;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform" style="transition: transform 0.3s ease;">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </label>
            
            <!-- Collapsed Sidebar Icons -->
            <div class="sidebar-icons py-3">
                <a href="{% url 'new_chat' %}" class="mx-auto mb-2 btn rounded-2 d-flex align-items-center justify-content-center" title="New conversation" style="width: 40px; height: 40px; background-color: var(--chatgpt-sidebar-hover); color: var(--chatgpt-text); border: 1px solid var(--chatgpt-border);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                </a>
                <label for="sidebar-collapse" class="mx-auto mb-2 btn rounded-2 d-flex align-items-center justify-content-center" title="Expand sidebar" style="width: 40px; height: 40px; background-color: var(--chatgpt-sidebar-hover); color: var(--chatgpt-text); border: 1px solid var(--chatgpt-border); cursor: pointer;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                </label>
            </div>
            
            <!-- Sidebar Content -->
            <div class="sidebar-content d-flex flex-column h-100" style="transition: opacity 0.3s ease;">
                <!-- Sidebar Header -->
                <div class="p-3 border-bottom">
                    <a href="{% url 'home' %}" class="text-decoration-none">
                        <h5 class="mb-0">Sahabat ChatBot</h5>
                    </a>
                </div>

                <!-- New Chat Button -->
                <div class="p-3">
                    <a href="{% url 'new_chat' %}" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center">
                        <svg class="me-2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        New Chat
                    </a>
                </div>

                <!-- RAG Features -->
                <div class="px-3 pb-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-secondary btn-sm d-flex align-items-center justify-content-center" 
                                hx-post="/toggle-rag-mode/" 
                                hx-target="#ragModeToggle"
                                hx-swap="innerHTML"
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                            <svg class="me-2" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            <span id="ragModeToggle">{% if request.session.rag_mode_enabled %}RAG Mode: ON{% else %}RAG Mode: OFF{% endif %}</span>
                        </button>
                        <a href="/rag/search/" class="btn btn-outline-secondary btn-sm d-flex align-items-center justify-content-center">
                            <svg class="me-2" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                            Search Docs
                        </a>
                        <a href="/rag/documents/" class="btn btn-outline-secondary btn-sm d-flex align-items-center justify-content-center">
                            <svg class="me-2" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            Manage Docs
                        </a>
                    </div>
                </div>

                <!-- Chat History -->
                <div class="chat-history flex-grow-1 px-3 pb-3 overflow-auto">
                    <div class="d-grid gap-1">
                        {% for chat in chat_history %}
                        <div class="chat-history-item p-2 rounded position-relative text-start border-0 d-flex align-items-center" style="transition: all 0.2s ease;">
                            <button class="delete-chat-btn btn btn-sm border-0 bg-transparent text-muted me-2" 
                                    hx-post="/chat/{{ chat.id }}/delete/" 
                                    hx-confirm="Are you sure you want to delete this conversation? This action cannot be undone."
                                    hx-target="closest .chat-history-item"
                                    hx-swap="outerHTML"
                                    title="Delete conversation">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                </svg>
                            </button>
                            <a href="/chat/{{ chat.id }}/" class="btn flex-grow-1 text-start p-0 border-0 bg-transparent" style="color: inherit; text-decoration: none;">
                                <div>{{ chat.title|default:"New conversation"|truncatechars:20 }}</div>
                                <small class="text-muted">{{ chat.created_at|date:"M d" }}</small>
                            </a>
                        </div>
                        {% empty %}
                        <div class="text-muted small text-center mt-4">
                            No previous conversations
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- User Menu -->
                <div class="mt-auto p-3 border-top">
                    {% if user.is_authenticated %}
                    <div class="dropdown">
                        <button class="btn btn-outline-primary w-100 text-start dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown">
                            <div class="rounded-circle d-flex align-items-center justify-content-center me-2 text-white" style="width: 30px; height: 30px; font-size: 0.75rem; font-weight: 600; background-color: var(--chatgpt-green);">
                                {% if user.first_name %}{{ user.first_name.0|upper }}{% elif user.username %}{{ user.username.0|upper }}{% else %}U{% endif %}
                            </div>
                            <span>{{ user.get_full_name|default:user.username|truncatechars:20 }}</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'profile' %}">Profile</a></li>
                            <li><a class="dropdown-item" href="{% url 'settings' %}">Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
                        </ul>
                    </div>
                    {% else %}
                    <div class="mb-3">
                        <a href="{% url 'login' %}" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center">
                            <svg class="me-2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                                <polyline points="10,17 15,12 10,7"/>
                                <line x1="15" y1="12" x2="3" y2="12"/>
                            </svg>
                            Sign in
                        </a>
                    </div>
                    <div class="mb-3">
                        <a href="{% url 'register' %}" class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center">
                            <svg class="me-2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <line x1="20" y1="8" x2="20" y2="14"/>
                                <line x1="23" y1="11" x2="17" y2="11"/>
                            </svg>
                            Register
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content flex-grow-1 d-flex flex-column">
            <!-- Header Bar -->
            <div class="chat-header d-flex justify-content-center align-items-center p-3 border-bottom" style="background-color: var(--chatgpt-bg); border-color: var(--chatgpt-border) !important;">
                <h6 class="mb-0" style="color: var(--chatgpt-text);">Chat with Sahabat Bot</h6>
            </div>
            
            <!-- Chat Messages -->
            <div class="chat-messages flex-grow-1 overflow-auto" id="chatMessages" style="padding-bottom: 140px;">
                {% load markdown_extras %}
                {% block content %}
                <div class="container-fluid">
                    {% for message in messages %}
                    <div class="message-container py-3 mb-3">
                        <div class="row justify-content-center">
                            <div class="col-12 col-lg-10">
                                <div class="d-flex align-items-start ps-3">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2 text-white fw-bold" style="width: 32px; height: 32px; font-size: 0.75rem; background-color: {% if message.sender == 'user' %}var(--chatgpt-green){% else %}var(--chatgpt-green){% endif %};">
                                        {% if message.sender == 'user' %}
                                            {% if user.first_name %}{{ user.first_name.0|upper }}{% elif user.username %}{{ user.username.0|upper }}{% else %}U{% endif %}
                                        {% else %}
                                            AI
                                        {% endif %}
                                    </div>
                                    {% if message.sender == 'user' %}
                                    <div class="user-bubble rounded-4 px-3 py-2" style="max-width: 70%; word-wrap: break-word; border-bottom-left-radius: 0.25rem !important;">
                                        <div class="lh-base">
                                            {{ message.content|linebreaks }}
                                        </div>
                                        <div class="small mt-1" style="color: var(--chatgpt-text-muted);">
                                            {{ message.created_at|date:"H:i" }}
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="px-3 py-2" style="max-width: 70%; word-wrap: break-word;">
                                        <div class="lh-base ai-message-content">
                                            {{ message.content|markdown_to_html|safe }}
                                        </div>
                                        <div class="small text-muted mt-1">
                                            {{ message.created_at|date:"H:i" }}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <!-- Welcome Message -->
                    <div class="d-flex align-items-center justify-content-center" style="min-height: 60vh;">
                        <div class="text-center">
                            <h1 class="display-6 mb-4">Sahabat ChatBot</h1>
                            {% if user.is_authenticated %}
                            <p class="lead text-muted mb-4">How can I help you today?</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <form hx-post="{% url 'set_prompt' %}" hx-target="#messageInput" hx-swap="outerHTML">
                                        {% csrf_token %}
                                        <input type="hidden" name="prompt" value="Explain quantum computing">
                                        <button type="submit" class="card bg-secondary border-0 h-100 btn p-0" style="width: 100%;">
                                            <div class="card-body">
                                                <h6 class="card-title">Explain concepts</h6>
                                                <p class="card-text small text-muted">Explain quantum computing in simple terms</p>
                                            </div>
                                        </button>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <form hx-post="{% url 'set_prompt' %}" hx-target="#messageInput" hx-swap="outerHTML">
                                        {% csrf_token %}
                                        <input type="hidden" name="prompt" value="Write a Python function to sort a list">
                                        <button type="submit" class="card bg-secondary border-0 h-100 btn p-0" style="width: 100%;">
                                            <div class="card-body">
                                                <h6 class="card-title">Code assistance</h6>
                                                <p class="card-text small text-muted">Write a Python function to sort a list</p>
                                            </div>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% else %}
                            <p class="lead text-muted mb-4">Please sign in to start chatting with the AI assistant.</p>
                            <div class="row g-3 justify-content-center">
                                <div class="col-md-4">
                                    <a href="{% url 'login' %}" class="btn btn-primary btn-lg w-100 d-flex align-items-center justify-content-center">
                                        <svg class="me-2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                                            <polyline points="10,17 15,12 10,7"/>
                                            <line x1="15" y1="12" x2="3" y2="12"/>
                                        </svg>
                                        Sign In
                                    </a>
                                </div>
                                <div class="col-md-4">
                                    <a href="{% url 'register' %}" class="btn btn-outline-primary btn-lg w-100 d-flex align-items-center justify-content-center">
                                        <svg class="me-2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                            <circle cx="8.5" cy="7" r="4"/>
                                            <line x1="20" y1="8" x2="20" y2="14"/>
                                            <line x1="23" y1="11" x2="17" y2="11"/>
                                        </svg>
                                        Register
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endblock %}
            </div>
        </div>

        <!-- Input Area -->
        {% if user.is_authenticated %}
        <div class="input-area position-fixed bottom-0 p-4" style="left: 280px; right: 0; z-index: 1000; background: linear-gradient(180deg, rgba(33, 33, 33, 0) 0%, var(--chatgpt-bg) 30%); transition: left 0.3s ease;">
            <div class="container-fluid">
                <div class="row justify-content-center">
                    <div class="col-12 col-lg-10">
                        <div class="position-relative">
                            <form method="post" 
                                  hx-post="{% url 'chat_api' %}"
                                  hx-target="#chatMessages"
                                  hx-swap="beforeend"
                                  hx-indicator=".htmx-indicator"
                                  hx-on::after-request="this.reset(); htmx.find('#chatMessages').scrollTop = htmx.find('#chatMessages').scrollHeight;"
                                  id="chatForm">
                                {% csrf_token %}
                                <div class="position-relative">
                                    <textarea 
                                        class="form-control chat-input border rounded-4 pe-5" 
                                        name="message" 
                                        id="messageInput"
                                        placeholder="{% if request.session.rag_mode_enabled %}Message to Sahabat Bot (RAG Mode)...{% else %}Message to Sahabat Bot...{% endif %}" 
                                        rows="2"
                                        style="resize: vertical; min-height: 72px; max-height: 200px; padding: 0.75rem 3rem 0.75rem 1rem;"
                                        hx-trigger="keydown[key=='Enter' && !shiftKey] from:body"
                                        hx-post="{% url 'chat_api' %}"
                                        hx-target="#chatMessages"
                                        hx-swap="beforeend"
                                        hx-include="closest form"
                                        required></textarea>
                                    <button type="submit" class="btn send-btn position-absolute end-0 bottom-0 m-2 rounded-3 d-flex align-items-center justify-content-center" id="sendBtn" style="width: 32px; height: 32px;">
                                        <span class="spinner-border spinner-border-sm htmx-indicator" style="width: 16px; height: 16px;"></span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="send-icon">
                                            <path d="M12 19V5M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </form>
                            <div class="text-center mt-2">
                                <small class="text-muted">Sahabat Bot can make mistakes. Consider checking important information.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Bootstrap 5.3 JavaScript Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>